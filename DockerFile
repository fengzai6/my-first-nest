# 1. 后端构建环境
FROM node:22-alpine AS backend-builder

WORKDIR /app

COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

COPY . .
RUN yarn build

# 2. 前端构建环境
FROM node:22-alpine AS frontend-builder

WORKDIR /app

COPY client/package.json client/yarn.lock ./client/
RUN cd client && yarn install --frozen-lockfile

COPY client ./client
RUN cd client && yarn build

# 3. 生产环境
FROM node:22-alpine

WORKDIR /app

# 安装生产依赖
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile --production

# 从后端构建环境复制构建产物
COPY --from=backend-builder /app/dist ./dist
# 从前端构建环境复制构建产物
COPY --from=frontend-builder /app/client/dist ./client/dist

# 复制脚本
COPY scripts/start.sh ./scripts/start.sh

CMD ["sh", "scripts/start.sh"]